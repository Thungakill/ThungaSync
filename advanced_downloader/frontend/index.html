<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThungaSync Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .hive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(20px, 1fr));
            gap: 4px;
        }
        .chunk-cell {
            width: 100%;
            padding-bottom: 100%; /* Maintain aspect ratio */
            position: relative;
            border-radius: 4px;
            transition: background-color 0.3s ease-in-out;
        }
        /* Hide scrollbar for cleaner look */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen">

    <!-- Connection Screen (Visible by default) -->
    <div id="connectionScreen" class="w-full max-w-md mx-auto p-8 text-center">
        <h1 class="text-4xl font-bold text-white mb-2">ThungaSync</h1>
        <p class="text-gray-400 mb-8">Enter the code from your local ThungaSync app to connect.</p>
        <div class="space-y-4">
            <input id="connectionCodeInput" type="text" placeholder="e.g., BLUE-CAT-7" class="w-full bg-gray-800 border-2 border-gray-700 text-white text-center text-lg font-mono tracking-widest rounded-lg p-4 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 focus:outline-none uppercase">
            <button id="connectButton" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-4 px-4 rounded-lg text-lg transition-colors">Connect</button>
        </div>
        <p id="connectionStatus" class="text-gray-500 text-sm mt-4 h-5"></p>
    </div>

    <!-- Main Dashboard (Hidden by default) -->
    <div id="dashboardScreen" class="container mx-auto p-4 md:p-6 lg:p-8 hidden">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">ThungaSync Hub</h1>
            <p id="fileName" class="text-gray-400 truncate">Initializing...</p>
        </header>

        <!-- Main Stats & Progress -->
        <div class="bg-gray-800 rounded-xl p-4 md:p-6 mb-6">
            <div class="mb-4">
                <div class="flex justify-between items-center text-sm text-gray-400 mb-1">
                    <span>Overall Progress</span>
                    <span id="progressText">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-4">
                    <div id="progressBar" class="bg-cyan-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div>
                    <div class="text-sm text-gray-400">Combined Speed</div>
                    <div id="totalSpeed" class="text-xl md:text-2xl font-semibold text-white">0 MB/s</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">ETA</div>
                    <div id="eta" class="text-xl md:text-2xl font-semibold text-white">--:--</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">Peers</div>
                    <div id="peerCount" class="text-xl md:text-2xl font-semibold text-white">0</div>
                </div>
                 <div>
                    <div class="text-sm text-gray-400">Completed</div>
                    <div id="completedChunks" class="text-xl md:text-2xl font-semibold text-white">0 / 0</div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Hive & Devices -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Chunk Hive -->
                <div class="bg-gray-800 rounded-xl p-4 md:p-6">
                    <h2 class="text-xl font-semibold text-white mb-4">Chunk Hive</h2>
                    <div id="hiveGrid" class="hive-grid"></div>
                </div>
                <!-- Devices -->
                <div class="bg-gray-800 rounded-xl p-4 md:p-6">
                    <h2 class="text-xl font-semibold text-white mb-4">Connected Devices</h2>
                    <div id="deviceList" class="space-y-4 max-h-64 overflow-y-auto no-scrollbar"></div>
                </div>
            </div>

            <!-- Monetization / Info Panel -->
            <div class="bg-gray-800 rounded-xl p-4 md:p-6 h-fit">
                <h2 class="text-xl font-semibold text-white mb-4">Support ThungaSync</h2>
                 <div class="space-y-4">
                    <!-- Ad Placeholder -->
                    <div class="bg-gray-700 rounded-lg p-4 text-center">
                        <span class="text-gray-400 text-sm">Ad Placeholder</span>
                        <div class="w-full h-48 mt-2 bg-gray-600 rounded flex items-center justify-center">
                            <span class="text-gray-500 text-xs">Banner Ad (e.g., 300x250)</span>
                        </div>
                    </div>
                 
                     <a href="#" class="block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-center transition-colors">
                        Upgrade Your Wi-Fi?
                        <span class="block text-sm font-normal opacity-80">Check out top-rated routers</span>
                    </a>
                 
                     <a href="#" class="block bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-lg text-center transition-colors">
                        Buy Me a Coffee
                         <span class="block text-sm font-normal opacity-80">Support development</span>
                    </a>
                </div>
            </div>
        </div>
   
        <footer class="text-center text-gray-500 text-sm mt-8">
             <p>ThungaSync P2P Downloader - &copy; 2025</p>
        </footer>
    </div>

    <script>
    
        const connectionScreen = document.getElementById('connectionScreen');
        const dashboardScreen = document.getElementById('dashboardScreen');
        const connectionCodeInput = document.getElementById('connectionCodeInput');
        const connectButton = document.getElementById('connectButton');
        const connectionStatus = document.getElementById('connectionStatus');

        const fileNameEl = document.getElementById('fileName');
        const progressBarEl = document.getElementById('progressBar');
        const progressTextEl = document.getElementById('progressText');
        const totalSpeedEl = document.getElementById('totalSpeed');
        const etaEl = document.getElementById('eta');
        const peerCountEl = document.getElementById('peerCount');
        const completedChunksEl = document.getElementById('completedChunks');
        const hiveGridEl = document.getElementById('hiveGrid');
        const deviceListEl = document.getElementById('deviceList');

      
        let totalSize = 0;
        let chunkStates = [];
        let lastUpdateTime = Date.now();
        let lastTotalDownloaded = 0;

        const SIGNALING_SERVER_URL = 'wss://cff6df5c.thungasync.pages.dev/ws'; 

        connectButton.addEventListener('click', () => {
            const code = connectionCodeInput.value.trim().toUpperCase();
            if (!code) {
                connectionStatus.textContent = "Please enter a connection code.";
                return;
            }
            connectionStatus.textContent = `Connecting to broker...`;
            connectToSignalingServer(code);
        });
        
      
        connectionCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                connectButton.click();
            }
        });


        function connectToSignalingServer(code) {
            const brokerSocket = new WebSocket(SIGNALING_SERVER_URL);

            brokerSocket.onopen = () => {
                connectionStatus.textContent = `Requesting session '${code}'...`;
                const requestMessage = { type: 'request', code: code };
                brokerSocket.send(JSON.stringify(requestMessage));
            };

            brokerSocket.onmessage = (event) => {
                const message = JSON.parse(event.data);
                if (message.type === 'found' && message.localIp) {
                    connectionStatus.textContent = `Master found at ${message.localIp}. Connecting directly...`;
                    brokerSocket.close();
                    connectToMaster(message.localIp);
                } else if (message.type === 'not_found') {
                    connectionStatus.textContent = `Session code '${code}' not found. Check the code and try again.`;
                    brokerSocket.close();
                } else {
                    connectionStatus.textContent = 'Received an invalid response from the broker.';
                    brokerSocket.close();
                }
            };

            brokerSocket.onerror = (error) => {
                console.error('Broker WebSocket error:', error);
                connectionStatus.textContent = 'Error connecting to the signaling server.';
            };
            
            brokerSocket.onclose = () => {
                console.log("Disconnected from broker.");
            };
        }

        function connectToMaster(localIp) {
            const wsUrl = `ws://${localIp}:${HTTP_PORT}/ws`;
            const masterSocket = new WebSocket(wsUrl);

            masterSocket.onopen = () => {
                console.log('Direct WebSocket connection to Master established.');
              
                connectionScreen.classList.add('hidden');
                dashboardScreen.classList.remove('hidden');
                document.body.classList.remove('flex', 'items-center', 'justify-center', 'min-h-screen');
            };

            masterSocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    updateUI(data);
                } catch (e) {
                    console.error('Failed to parse message from Master:', e);
                }
            };

            masterSocket.onclose = () => {
                console.log('Connection to Master lost. Re-enabling connection screen.');
              
                dashboardScreen.classList.add('hidden');
                connectionScreen.classList.remove('hidden');
                document.body.classList.add('flex', 'items-center', 'justify-center', 'min-h-screen');
                connectionStatus.textContent = "Connection to Master lost. Please reconnect.";
            };

            masterSocket.onerror = (error) => {
                console.error('Master WebSocket error:', error);
                masterSocket.close();
            };
        }
        
    
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds === Infinity || seconds < 0) {
                return '--:--';
            }
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }
        
        function updateUI(data) {
            const { metadata, workers } = data;
            
            const pathParts = metadata.output_path.split(/[\\/]/);
            fileNameEl.textContent = pathParts[pathParts.length - 1];
            totalSize = metadata.total_size;

            const completedCount = metadata.chunks.filter(c => c.state === 'Completed').length;
            const totalCount = metadata.chunks.length;
            
            const progressPercent = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;
            progressBarEl.style.width = `${progressPercent}%`;
            progressTextEl.textContent = `${progressPercent.toFixed(1)}%`;

            completedChunksEl.textContent = `${completedCount} / ${totalCount}`;
            
            if (chunkStates.length !== metadata.chunks.length) {
                hiveGridEl.innerHTML = '';
                metadata.chunks.forEach(chunk => {
                    const cell = document.createElement('div');
                    cell.id = `chunk-${chunk.id}`;
                    cell.className = 'chunk-cell bg-gray-700';
                    hiveGridEl.appendChild(cell);
                });
                chunkStates = metadata.chunks.map(c => c.state);
            } else {
                 metadata.chunks.forEach((chunk, index) => {
                    if (chunk.state !== chunkStates[index]) {
                        const cell = document.getElementById(`chunk-${chunk.id}`);
                        if (cell) {
                            if (chunk.state === 'InProgress') cell.className = 'chunk-cell bg-blue-600';
                            else if (chunk.state === 'Completed') cell.className = 'chunk-cell bg-green-600';
                            else cell.className = 'chunk-cell bg-gray-700';
                        }
                        chunkStates[index] = chunk.state;
                    }
                });
            }

            deviceListEl.innerHTML = '';
            const activeWorkers = Object.values(workers);
            const uniquePeers = new Set(activeWorkers.map(w => w.id.startsWith("Master-") ? "Master" : w.id));
            peerCountEl.textContent = uniquePeers.size;

            let totalBytesInProgress = 0;

            activeWorkers.forEach(worker => {
                const chunk = worker.current_chunk !== null ? metadata.chunks.find(c => c.id === worker.current_chunk) : null;
                const chunkSize = chunk ? (chunk.end - chunk.start + 1) : 0;
                const chunkProgress = chunkSize > 0 ? (worker.progress / chunkSize) * 100 : 0;
                totalBytesInProgress += worker.progress;

                const deviceCard = `
                    <div class="bg-gray-700 rounded-lg p-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                                <span class="font-medium text-white">${worker.id}</span>
                            </div>
                            <span class="text-xs text-gray-400">${chunk ? `Chunk #${chunk.id}` : 'Idle'}</span>
                        </div>
                        ${chunk ? `
                        <div class="mt-2">
                            <div class="w-full bg-gray-600 rounded-full h-2.5">
                                <div class="bg-blue-500 h-2.5 rounded-full" style="width: ${chunkProgress.toFixed(2)}%"></div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                deviceListEl.innerHTML += deviceCard;
            });
            
            const totalBytesCompleted = metadata.chunks
                .filter(c => c.state === 'Completed')
                .reduce((acc, c) => acc + (c.end - c.start + 1), 0);
            const currentTotalDownloaded = totalBytesCompleted + totalBytesInProgress;
            const now = Date.now();
            const timeDiff = (now - lastUpdateTime) / 1000;

            if (timeDiff > 0.5) { 
                const bytesDownloadedSinceLastUpdate = currentTotalDownloaded - lastTotalDownloaded;
                const speed = bytesDownloadedSinceLastUpdate / timeDiff;
                totalSpeedEl.textContent = `${formatBytes(speed, 2)}/s`;
                const remainingBytes = totalSize - currentTotalDownloaded;
                etaEl.textContent = formatTime(speed > 0 ? remainingBytes / speed : Infinity);
                lastUpdateTime = now;
                lastTotalDownloaded = currentTotalDownloaded;
            }
        }
    </script>
</body>
</html>

